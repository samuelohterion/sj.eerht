<!DOCTYPE html>
<html>

	<head>

		<meta charset="utf-8" />

		<title>fabric 1</title>

		<style type="text/css">

		</style>

<!--
		<script src="../../../three.js/build/three.js" type="text/javascript"></script>

		<script src="../../../three.js/examples/js/controls/OrbitControls.js" type="text/javascript"></script>

		<script src="../../../three.js/examples/js/libs/stats.min.js"></script>

		<script src="../../../three.js/examples/js/libs/dat.gui.min.js"></script>
-->

		<script src="https://threejs.org/build/three.js" type="text/javascript"></script>

		<script src="https://threejs.org/examples/js/controls/OrbitControls.js" type="text/javascript"></script>

		<script src="https://threejs.org/examples/js/libs/stats.min.js"></script>

		<script src="https://threejs.org/examples/js/libs/dat.gui.min.js"></script>

		<script src="fabric1.js" type="text/javascript"></script>

	</head>

	<body>

<!--		<button id="startStop" onclick="startStop( );">start simulaion</button>

		<button id="reset" onclick="reset( );">reset</button>
-->
		<script type="text/javascript">

			var
			WDTH = 50;

			var
			tm   = ( new Date ( ) ).getTime ( ),
			then = ( new Date ( ) ).getTime ( ) - tm,
			now  = ( new Date ( ) ).getTime ( ) - tm;

			var
			cmr  = new THREE.PerspectiveCamera ( 60, window.innerWidth / window.innerHeight, .1, 10000 );
			cmr.position.set ( 0., 0, 2. * WDTH );
			cmr.up.set( 0, 1, 0 );
			cmr.lookAt( new THREE.Vector3 ( 0, WDTH, 0 ) );

			var
			rndr = new THREE.WebGLRenderer ( );
			rndr.setSize ( window.innerWidth, window.innerHeight );
			rndr.shadowMap.enabled = true;

			document.body.appendChild ( rndr.domElement );

			var
			oCtl = new THREE.OrbitControls( cmr );
			oCtl.addEventListener( 'change', render );

			var
			scn = new THREE.Scene( );

			var
			lta = new THREE.AmbientLight( 0x404040, 2 ),
			lgt = new THREE.PointLight( 0x80c0f0, 3, 2.5 * WDTH, 2 ),
			lth = new THREE.PointLightHelper( lgt, 1 );
			lgt.position.set( 0, .5 * WDTH, +.25 * WDTH );

			scn.add( lta );
			scn.add( lgt );
			scn.add( lth );

			var
			fabrique = new My.Fabrique ( WDTH, 2e3 );
			fabrique.mesh.geometry.translate( 0., 1.* WDTH, -.5 * WDTH );

			scn.add ( fabrique.mesh );

			reset( );

			function animate ( ) {

				requestAnimationFrame ( animate );

				now  = ( new Date ( ) ).getTime ( ) - tm;

				var
				dt = 1e-3 * ( now - then );

				then = now;

				if( 1. < dt || dt < 1. / 120. )

					return;

				for ( var i = 0; i < 10;++i )

					fabrique.live ( .1 * dt );

//				fabrique.mesh.rotateY( .000 );

				fabrique.mesh.geometry.computeFaceNormals ( );
				fabrique.mesh.geometry.computeVertexNormals ( );

				fabrique.mesh.geometry.verticesNeedUpdate = true;
				fabrique.mesh.geometry.normalsNeedUpdate  = true;
				fabrique.mesh.geometry.colorsNeedUpdate   = true;
				fabrique.mesh.geometry.dynamic            = true;


				render ( );
			}

			function render ( ) {

				rndr.render ( scn, cmr );
			}

			function reset( ) {

				tm   = ( new Date ( ) ).getTime ( );
				then = ( new Date ( ) ).getTime ( ) - tm;
				now  = ( new Date ( ) ).getTime ( ) - tm;

				fabrique.mesh.geometry.computeFaceNormals ( );
				fabrique.mesh.geometry.computeVertexNormals ( );

				requestAnimationFrame ( render );
			}

			animate ( );

		</script>

	</body>

</html>
